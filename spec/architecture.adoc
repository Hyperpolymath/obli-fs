= ObliFS Architecture
:toc:
:toclevels: 2

Visual and structural overview of the ObliFS system.

'''

== Layer Diagram

[source]
----
┌─────────────────────────────────────────────────────────────────────┐
│                        APPLICATIONS                                  │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│   │  Native API  │  │  FUSE Mount  │  │  S3 Compat   │              │
│   │   (typed)    │  │   (POSIX)    │  │   (REST)     │              │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└──────────┼─────────────────┼─────────────────┼──────────────────────┘
           │                 │                 │
           ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ObliFS COORDINATION LAYER                       │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                         ROUTER                               │    │
│  │              (message routing, topology)                     │    │
│  └─────────────────────────────────────────────────────────────┘    │
│           │              │              │              │             │
│           ▼              ▼              ▼              ▼             │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │
│  │   ACTOR    │  │   ACTOR    │  │   ACTOR    │  │   ACTOR    │    │
│  │  (data)    │◄─┼──►(index)  │◄─┼──►(backup) │◄─┼──►(audit)  │    │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘    │
│        │              │              │              │                │
│        └──────────────┴──────────────┴──────────────┘                │
│                          CHANNELS                                    │
│                   (consent-based, typed)                             │
│                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │    WORKFLOW     │  │    ARCHIVE      │  │    MANIFEST     │      │
│  │  (orchestration)│  │   (history)     │  │   (specs)       │      │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
           │                 │                 │
           ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        ADAPTER LAYER                                 │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│   │  Local FS    │  │  Object Store│  │  Distributed │              │
│   │   Adapter    │  │   Adapter    │  │  FS Adapter  │              │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└──────────┼─────────────────┼─────────────────┼──────────────────────┘
           │                 │                 │
           ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        STORAGE BACKENDS                              │
│        ext4/ZFS/APFS     S3/GCS/Azure        Ceph/GlusterFS         │
└─────────────────────────────────────────────────────────────────────┘
----

'''

== Entity Relationships

[source]
----
                    ┌─────────────┐
                    │  MANIFEST   │
                    │ (immutable) │
                    └──────┬──────┘
                           │ defines
                           ▼
┌─────────────────────────────────────────────────────────┐
│                        ACTOR                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   mailbox   │  │    state    │  │  manifest   │     │
│  │  (queue)    │  │  (mutable)  │  │   (ref)     │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└───────────┬─────────────────────────────────┬───────────┘
            │                                 │
            │ sends/receives                  │ logs to
            ▼                                 ▼
     ┌─────────────┐                   ┌─────────────┐
     │   CHANNEL   │                   │   ARCHIVE   │
     │ (stateless) │                   │(append-only)│
     └──────┬──────┘                   └─────────────┘
            │
            │ requires
            ▼
     ┌─────────────┐
     │   CONSENT   │
     │   PROOF     │
     └─────────────┘
            │
            │ from
            ▼
     ┌─────────────┐
     │ CAPABILITY  │
     │  (token)    │
     └─────────────┘
----

'''

== Message Flow

[source]
----
┌──────────┐                                              ┌──────────┐
│ ACTOR A  │                                              │ ACTOR B  │
│          │                                              │          │
│ ┌──────┐ │    1. Request Channel                        │ ┌──────┐ │
│ │state │ │ ─────────────────────────────────────────►   │ │state │ │
│ └──────┘ │       (with capability)                      │ └──────┘ │
│          │                                              │          │
│ ┌──────┐ │    2. Consent Request                        │ ┌──────┐ │
│ │mail- │ │       (forwarded by system)                  │ │mail- │ │
│ │box   │ │ ◄───────────────────────────────────────     │ │box   │ │
│ └──────┘ │                                              │ └──────┘ │
│          │    3. Consent Response                       │          │
│          │       (with capability)                      │          │
│          │ ─────────────────────────────────────────►   │          │
│          │                                              │          │
└──────────┘                                              └──────────┘
     │                                                          │
     │         4. Channel Created (ConsentProof)                │
     │◄────────────────────────────────────────────────────────►│
     │                                                          │
     │                    ┌──────────┐                          │
     │                    │ CHANNEL  │                          │
     │◄──────────────────►│(C_A_B)   │◄─────────────────────────►│
     │   5. Messages      └──────────┘      5. Messages         │
     │      (typed)            │            (typed)             │
     │                         │                                │
     │                         ▼                                │
     │                   ┌──────────┐                           │
     │                   │ ARCHIVE  │                           │
     │                   │(logged)  │                           │
     │                   └──────────┘                           │
----

'''

== Type Derivation from Oblíbený

[source]
----
                    ┌───────────────────────────┐
                    │      OBLÍBENÝ CORE        │
                    │    (Turing-complete)      │
                    │                           │
                    │  • Full language          │
                    │  • syscall, recursion     │
                    │  • while/for loops        │
                    │  • dynamic allocation     │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │      PHASE SEPARATION     │
                    │   (compile-time → deploy) │
                    └─────────────┬─────────────┘
                                  │
          ┌───────────────────────┼───────────────────────┐
          │                       │                       │
          ▼                       ▼                       ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│    MANIFEST     │   │     ACTOR       │   │    CHANNEL      │
│                 │   │                 │   │                 │
│ No execution    │   │ Bounded loops   │   │ No state        │
│ No mutation     │   │ No recursion    │   │ No computation  │
│ No I/O          │   │ No syscall      │   │ Forward only    │
│ Validate only   │   │ Type-bounded    │   │ Protocol-bound  │
└─────────────────┘   └─────────────────┘   └─────────────────┘
          │                       │                       │
          ▼                       ▼                       ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│    WORKFLOW     │   │    ARCHIVE      │   │     ROUTER      │
│                 │   │                 │   │                 │
│ Compose ops     │   │ Append-only     │   │ Headers only    │
│ Via channels    │   │ No delete       │   │ No content      │
│ Handle errors   │   │ Prove provenance│   │ Route messages  │
└─────────────────┘   └─────────────────┘   └─────────────────┘
----

'''

== Capability Flow

[source]
----
┌──────────────────────────────────────────────────────────────────┐
│                        CAPABILITY LIFECYCLE                       │
└──────────────────────────────────────────────────────────────────┘

  ┌─────────┐                                          ┌─────────┐
  │  GRANT  │                                          │  USE    │
  └────┬────┘                                          └────┬────┘
       │                                                    │
       ▼                                                    ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────────────────┐
│ Capability  │─────►│  Holder     │─────►│ Present to Target       │
│ Created     │      │  Receives   │      │ (channel creation or    │
│             │      │             │      │  direct operation)      │
└─────────────┘      └─────────────┘      └───────────┬─────────────┘
                                                      │
                            ┌─────────────────────────┴─────────────┐
                            │                                       │
                            ▼                                       ▼
                     ┌─────────────┐                         ┌─────────────┐
                     │ VALIDATED   │                         │ REJECTED    │
                     │             │                         │             │
                     │ • Operation │                         │ • Logged    │
                     │   proceeds  │                         │ • No effect │
                     │ • Logged    │                         │             │
                     └─────────────┘                         └─────────────┘


  ┌──────────┐                     ┌──────────┐
  │ DELEGATE │                     │ REVOKE   │
  └────┬─────┘                     └────┬─────┘
       │                                │
       ▼                                ▼
┌─────────────┐                  ┌─────────────┐
│ New holder  │                  │ Capability  │
│ receives    │                  │ invalidated │
│ (possibly   │                  │             │
│  restricted)│                  │ • Future    │
│             │                  │   uses fail │
└─────────────┘                  └─────────────┘
----

'''

== Deployment Topology Example

[source]
----
┌─────────────────────────────────────────────────────────────────────┐
│                           EDGE NODE A                                │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    ObliFS Instance                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │Sensor   │  │Local    │  │Audit    │  │Sync     │         │   │
│  │  │Actor    │  │Store    │  │Actor    │  │Actor    │         │   │
│  │  │         │  │Actor    │  │         │  │  ●──────┼─────────┼───┼──┐
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘         │   │  │
│  └──────────────────────────────────────────────────────────────┘   │  │
│                            │                                         │  │
│                   ┌────────┴────────┐                               │  │
│                   │  Local Storage  │                               │  │
│                   └─────────────────┘                               │  │
└─────────────────────────────────────────────────────────────────────┘  │
                                                                         │
                                    ┌────────────────────────────────────┘
                                    │  (channels across nodes)
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           EDGE NODE B                                │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    ObliFS Instance                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │Actuator │  │Local    │  │Audit    │  │Sync     │         │   │
│  │  │Actor    │  │Store    │  │Actor    │  │Actor    │         │   │
│  │  │         │  │Actor    │  │         │  │  ●      │         │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘         │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                            │                                         │
│                   ┌────────┴────────┐                               │
│                   │  Local Storage  │                               │
│                   └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │  (channels to cloud)
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         CLOUD / CENTRAL                              │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    ObliFS Instance                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │Aggregat-│  │Central  │  │Master   │  │Sync     │         │   │
│  │  │or Actor │  │Archive  │  │Audit    │  │Coord    │         │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘         │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                            │                                         │
│                   ┌────────┴────────┐                               │
│                   │  Object Store   │                               │
│                   │  (S3/GCS)       │                               │
│                   └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────────┘
----

'''

== File/Directory Structure

[source]
----
obli-fs/
├── grammar/
│   └── oblibeny-v0.6.ebnf     # Oblíbený language grammar
│
├── spec/
│   ├── type-specification.adoc # Formal entity type definitions
│   └── architecture.adoc       # This file
│
├── outreach/
│   ├── technical-summary.adoc  # One-page overview (no metaphors)
│   ├── elevator-pitch.adoc     # Pitches for different audiences
│   ├── faq-objections.adoc     # Anticipated pushback
│   ├── glossary.adoc           # Metaphor → technical term mapping
│   └── comparison.adoc         # vs. existing systems
│
├── src/                        # Implementation (future)
│   ├── core/                   # Core types and message passing
│   ├── entities/               # Entity type implementations
│   ├── adapters/               # Storage backend adapters
│   └── runtime/                # Coordination runtime
│
└── examples/                   # Example configurations (future)
----
